<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ESP32 Car Control | Modern UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for a modern look and feel */
      body {
        font-family: "Poppins", sans-serif;
      }

      /* Keyframe animation for the control panel fade-in */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      /* Custom styling for the range slider */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: #4a5568; /* bg-gray-700 */
        border-radius: 5px;
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      input[type="range"]:hover {
        opacity: 1;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: #4299e1; /* bg-blue-500 */
        cursor: pointer;
        border-radius: 50%;
        border: 4px solid #1a202c; /* bg-gray-900 */
      }

      input[type="range"]::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: #4299e1; /* bg-blue-500 */
        cursor: pointer;
        border-radius: 50%;
        border: 4px solid #1a202c; /* bg-gray-900 */
      }
    </style>
  </head>
  <body
    class="bg-gray-900 bg-gradient-to-br from-gray-900 to-slate-800 text-slate-200 flex items-center justify-center h-screen"
  >
    <div
      class="animate-fade-in w-full max-w-sm p-8 space-y-8 bg-gray-800/50 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-700"
    >
      <h1 class="text-3xl font-bold text-center text-white">
        <span class="text-blue-400">ESP32</span> Rover Control
      </h1>

      <div class="grid grid-cols-3 grid-rows-3 gap-3 w-48 mx-auto">
        <button
          id="btn-forward"
          onclick="sendCmd('forward')"
          class="col-start-2 row-start-1 bg-gray-700 hover:bg-blue-600 active:scale-95 transform transition-all duration-200 rounded-lg flex justify-center items-center aspect-square"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 15l7-7 7 7"
            />
          </svg>
        </button>
        <button
          id="btn-left"
          onclick="sendCmd('left')"
          class="col-start-1 row-start-2 bg-gray-700 hover:bg-blue-600 active:scale-95 transform transition-all duration-200 rounded-lg flex justify-center items-center aspect-square"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </button>
        <button
          id="btn-stop"
          onclick="sendCmd('stop')"
          class="col-start-2 row-start-2 bg-red-600 hover:bg-red-700 active:scale-95 transform transition-all duration-200 rounded-full flex justify-center items-center aspect-square text-white font-bold"
        >
          STOP
        </button>
        <button
          id="btn-right"
          onclick="sendCmd('right')"
          class="col-start-3 row-start-2 bg-gray-700 hover:bg-blue-600 active:scale-95 transform transition-all duration-200 rounded-lg flex justify-center items-center aspect-square"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>
        <button
          id="btn-backward"
          onclick="sendCmd('backward')"
          class="col-start-2 row-start-3 bg-gray-700 hover:bg-blue-600 active:scale-95 transform transition-all duration-200 rounded-lg flex justify-center items-center aspect-square"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>
      </div>

      <div class="space-y-3 pt-4">
        <div class="flex justify-between items-center px-1">
          <label class="font-semibold text-white">Speed</label>
          <span id="speedValue" class="text-blue-400 font-mono text-lg"
            >150</span
          >
        </div>
        <input
          id="speedSlider"
          type="range"
          min="0"
          max="255"
          value="150"
          oninput="sendSpeed(this.value); document.getElementById('speedValue').innerText = this.value"
        />
      </div>

      <div class="pt-4">
        <label
          for="ledToggle"
          class="flex items-center justify-between cursor-pointer"
        >
          <span class="font-semibold text-white">Vehicle LED</span>
          <div class="relative">
            <input
              type="checkbox"
              id="ledToggle"
              class="sr-only peer"
              onchange="toggleLED()"
            />
            <div
              class="w-14 h-8 bg-gray-600 rounded-full peer-checked:bg-green-500 transition-colors duration-300"
            ></div>
            <div
              class="absolute left-1 top-1 bg-white w-6 h-6 rounded-full peer-checked:translate-x-6 transition-transform duration-300"
            ></div>
          </div>
        </label>
      </div>
    </div>

    <script>
      // --- MQTT Configuration ---
      const brokerUrl =
        "wss://d5290c53857e48048d3e9a4408847c9f.s1.eu.hivemq.cloud:8884/mqtt";
      const options = {
        username: "manish",
        password: "Mshakya@2110",
        clean: true,
        connectTimeout: 4000,
      };
      const topicControl = "esp32/car/control";
      const topicSpeed = "esp32/car/speed";
      const topicLED = "esp32/car/led";

      // --- MQTT Client Initialization ---
      const client = mqtt.connect(brokerUrl, options);

      client.on("connect", () => {
        console.log("âœ… Connected to HiveMQ Cloud Broker");
      });
      client.on("error", (err) => {
        console.error("Connection error: ", err);
        client.end();
      });

      // --- Control Functions ---
      function sendCmd(cmd) {
        if (!client.connected) return;
        client.publish(topicControl, cmd);
        console.log(`Sent command: ${cmd}`);
      }

      function sendSpeed(value) {
        if (!client.connected) return;
        client.publish(topicSpeed, value.toString());
        console.log(`Speed set: ${value}`);
      }

      function toggleLED() {
        if (!client.connected) return;
        const isChecked = document.getElementById("ledToggle").checked;
        const state = isChecked ? "ON" : "OFF";
        client.publish(topicLED, state);
        console.log(`LED toggled: ${state}`);
      }

      // --- NEW: KEYBOARD CONTROL LOGIC ---

      // Get button elements for visual feedback
      const buttons = {
        forward: document.getElementById("btn-forward"),
        backward: document.getElementById("btn-backward"),
        left: document.getElementById("btn-left"),
        right: document.getElementById("btn-right"),
        stop: document.getElementById("btn-stop"),
      };

      // Listen for key presses
      document.addEventListener("keydown", (event) => {
        // Prevent repeated commands if a key is held down
        if (event.repeat) return;

        switch (event.key) {
          case "ArrowUp":
            sendCmd("forward");
            buttons.forward.classList.add("bg-blue-600", "scale-95");
            break;
          case "ArrowDown":
            sendCmd("backward");
            buttons.backward.classList.add("bg-blue-600", "scale-95");
            break;
          case "ArrowLeft":
            sendCmd("left");
            buttons.left.classList.add("bg-blue-600", "scale-95");
            break;
          case "ArrowRight":
            sendCmd("right");
            buttons.right.classList.add("bg-blue-600", "scale-95");
            break;
          case " ": // Space bar
            sendCmd("stop");
            buttons.stop.classList.add("bg-red-700", "scale-95");
            break;
        }
      });

      // Listen for key releases to stop movement and reset button visuals
      document.addEventListener("keyup", (event) => {
        switch (event.key) {
          case "ArrowUp":
            buttons.forward.classList.remove("bg-blue-600", "scale-95");
            sendCmd("stop"); // Optional: stop when arrow key is released
            break;
          case "ArrowDown":
            buttons.backward.classList.remove("bg-blue-600", "scale-95");
            sendCmd("stop"); // Optional: stop when arrow key is released
            break;
          case "ArrowLeft":
            buttons.left.classList.remove("bg-blue-600", "scale-95");
            sendCmd("stop"); // Optional: stop when arrow key is released
            break;
          case "ArrowRight":
            buttons.right.classList.remove("bg-blue-600", "scale-95");
            sendCmd("stop"); // Optional: stop when arrow key is released
            break;
          case " ": // Space bar
            buttons.stop.classList.remove("bg-red-700", "scale-95");
            break;
        }
      });
    </script>
  </body>
</html>
