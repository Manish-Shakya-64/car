<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 Rover Control | Modern UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for a modern look and feel */
      body {
        font-family: "Poppins", sans-serif;
        overflow-x: hidden;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
      }

      /* Glass morphism effect */
      .glass {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Keyframe animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.5);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(66, 153, 225, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(66, 153, 225, 0);
        }
      }

      @keyframes lightPulse {
        0% {
          box-shadow: 0 0 5px 0 rgba(245, 158, 11, 0.5);
        }
        50% {
          box-shadow: 0 0 15px 5px rgba(245, 158, 11, 0.8);
        }
        100% {
          box-shadow: 0 0 5px 0 rgba(245, 158, 11, 0.5);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.6s ease-out forwards;
      }

      .animate-pulse-ring {
        animation: pulse 2s infinite;
      }

      .animate-light-pulse {
        animation: lightPulse 2s infinite;
      }

      /* Custom styling for the range slider */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 10px;
        background: linear-gradient(to right, #1e40af, #3b82f6);
        border-radius: 10px;
        outline: none;
        opacity: 0.85;
        transition: opacity 0.2s;
      }

      input[type="range"]:hover {
        opacity: 1;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 26px;
        height: 26px;
        background: #ffffff;
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid #3b82f6;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      input[type="range"]::-moz-range-thumb {
        width: 26px;
        height: 26px;
        background: #ffffff;
        cursor: pointer;
        border-radius: 50%;
        border: 3px solid #3b82f6;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }

      /* Connection status indicator */
      .connection-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .connected {
        background-color: #10b981;
        box-shadow: 0 0 8px #10b981;
      }
      .disconnected {
        background-color: #ef4444;
      }
      .connecting {
        background-color: #f59e0b;
        animation: pulse 1.5s infinite;
      }

      /* Responsive adjustments */
      @media (max-width: 640px) {
        .control-container {
          padding: 1.5rem;
        }
        .d-pad {
          width: 280px;
          height: 280px;
        }
        .control-btn {
          width: 80px;
          height: 80px;
        }
      }

      /* Touch-friendly button enhancements */
      .control-btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      /* Active button state */
      .btn-active {
        background: linear-gradient(
          135deg,
          #3b82f6 0%,
          #1d4ed8 100%
        ) !important;
        transform: scale(0.95);
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
      }

      /* Stop button active state */
      .stop-active {
        background: linear-gradient(
          135deg,
          #ef4444 0%,
          #dc2626 100%
        ) !important;
        transform: scale(0.95);
        box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
      }

      /* Custom toggle switch */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #4b5563;
        transition: 0.4s;
        border-radius: 34px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked + .toggle-slider {
        background-color: #f59e0b;
      }

      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }

      /* Light indicator */
      .light-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        background-color: #4b5563;
        transition: background-color 0.3s;
      }

      .light-on {
        background-color: #f59e0b;
        box-shadow: 0 0 10px #f59e0b;
      }
    </style>
  </head>
  <body
    class="text-slate-200 min-h-screen flex items-center justify-center p-4"
  >
    <div
      class="animate-fade-in w-full max-w-md glass rounded-3xl shadow-2xl overflow-hidden"
    >
      <!-- Header with connection status -->
      <div
        class="bg-gradient-to-r from-blue-600/30 to-purple-600/30 p-6 text-center relative"
      >
        <h1 class="text-3xl font-bold text-white mb-2">
          <span
            class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400"
            >ESP32</span
          >
          Rover Control
        </h1>
        <div class="flex items-center justify-center text-sm">
          <span id="connectionStatus" class="connection-dot connecting"></span>
          <span id="statusText" class="font-medium">Connecting...</span>
        </div>
      </div>

      <div class="control-container p-6 space-y-8">
        <!-- Directional Controls -->
        <div class="flex flex-col items-center">
          <div class="relative d-pad w-64 h-64 mx-auto mb-4">
            <!-- Center stop button -->
            <button
              id="btn-stop"
              class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 control-btn bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 shadow-lg rounded-full flex justify-center items-center z-10 w-20 h-20 text-white font-bold"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>

            <!-- Directional buttons arranged in a circle -->
            <button
              id="btn-forward"
              class="absolute top-0 left-1/2 transform -translate-x-1/2 control-btn bg-gradient-to-br from-slate-700 to-slate-800 hover:from-blue-600 hover:to-blue-700 shadow-lg rounded-xl flex justify-center items-center w-16 h-16"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 15l7-7 7 7"
                />
              </svg>
            </button>

            <button
              id="btn-left"
              class="absolute top-1/2 left-0 transform -translate-y-1/2 control-btn bg-gradient-to-br from-slate-700 to-slate-800 hover:from-blue-600 hover:to-blue-700 shadow-lg rounded-xl flex justify-center items-center w-16 h-16"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>

            <button
              id="btn-right"
              class="absolute top-1/2 right-0 transform -translate-y-1/2 control-btn bg-gradient-to-br from-slate-700 to-slate-800 hover:from-blue-600 hover:to-blue-700 shadow-lg rounded-xl flex justify-center items-center w-16 h-16"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>

            <button
              id="btn-backward"
              class="absolute bottom-0 left-1/2 transform -translate-x-1/2 control-btn bg-gradient-to-br from-slate-700 to-slate-800 hover:from-blue-600 hover:to-blue-700 shadow-lg rounded-xl flex justify-center items-center w-16 h-16"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-8 w-8"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
          </div>

          <p class="text-slate-400 text-sm text-center mt-2">
            Press and hold to move | Press STOP to halt
          </p>
        </div>

        <!-- Speed Control -->
        <div class="space-y-4 pt-2">
          <div class="flex justify-between items-center px-1">
            <label class="font-semibold text-white flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-2 text-blue-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Speed Control
            </label>
            <span
              id="speedValue"
              class="text-blue-400 font-mono text-lg bg-blue-900/30 px-3 py-1 rounded-full"
              >50%</span
            >
          </div>
          <input
            id="speedSlider"
            type="range"
            min="0"
            max="100"
            value="50"
            oninput="updateSpeed(this.value)"
          />
          <div class="flex justify-between text-xs text-slate-400 px-1">
            <span>0% (Stop)</span>
            <span>100% (Max)</span>
          </div>
          <div class="text-xs text-slate-500 text-center mt-1">
            Speed 1% = PWM 160 | Speed 100% = PWM 255
          </div>
        </div>

        <!-- Light Toggle -->
        <div class="pt-4">
          <div
            class="flex items-center justify-between p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 transition-colors"
          >
            <div class="flex items-center">
              <span id="lightIndicator" class="light-indicator"></span>
              <span class="font-semibold text-white flex items-center">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 mr-2 text-yellow-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  />
                </svg>
                Vehicle Lights
              </span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="lightToggle" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Connection Info -->
        <div class="pt-2 text-center">
          <p class="text-slate-400 text-sm">Connected to HiveMQ Cloud</p>
        </div>
      </div>
    </div>

    <script>
      // --- MQTT Configuration ---
      const brokerUrl =
        "wss://d5290c53857e48048d3e9a4408847c9f.s1.eu.hivemq.cloud:8884/mqtt";
      const options = {
        username: "manish",
        password: "Mshakya@2110",
        clean: true,
        connectTimeout: 4000,
      };
      const topicControl = "esp32/car/control";
      const topicSpeed = "esp32/car/speed";
      const topicLED = "esp32/car/led";

      // --- MQTT Client Initialization ---
      const client = mqtt.connect(brokerUrl, options);

      // Update connection status UI
      function updateConnectionStatus(status, text) {
        const statusDot = document.getElementById("connectionStatus");
        const statusText = document.getElementById("statusText");

        statusDot.className = "connection-dot " + status;
        statusText.textContent = text;
      }

      client.on("connect", () => {
        console.log("✅ Connected to HiveMQ Cloud Broker");
        updateConnectionStatus("connected", "Connected to Rover");
      });

      client.on("error", (err) => {
        console.error("Connection error: ", err);
        updateConnectionStatus("disconnected", "Connection Failed");
        client.end();
      });

      client.on("reconnect", () => {
        updateConnectionStatus("connecting", "Reconnecting...");
      });

      client.on("offline", () => {
        updateConnectionStatus("disconnected", "Disconnected");
      });

      // --- Control Variables ---
      let currentDirection = null;
      let currentSpeed = 50; // Default speed 50%
      let intervalId = null;
      let isMoving = false;
      let isLightOn = false;

      // Function to convert speed percentage to PWM value
      function speedToPWM(speedPercent) {
        if (speedPercent === 0) return 0;
        // Map 1-100% to 160-255 PWM
        return Math.round(160 + (speedPercent / 100) * 95);
      }

      // Function to send speed command
      function sendSpeed() {
        if (!client.connected) return;
        const pwmValue = speedToPWM(currentSpeed);
        client.publish(topicSpeed, pwmValue.toString());
        console.log(`Speed set: ${currentSpeed}% (PWM: ${pwmValue})`);
      }

      // Function to update speed display and send command
      function updateSpeed(value) {
        currentSpeed = parseInt(value);
        document.getElementById("speedValue").innerText = currentSpeed + "%";
        sendSpeed();
      }

      // Function to toggle lights
      function toggleLights() {
        if (!client.connected) return;

        isLightOn = !isLightOn;
        const state = isLightOn ? "ON" : "OFF";
        client.publish(topicLED, state);
        console.log(`Lights toggled: ${state}`);

        // Update UI
        const lightIndicator = document.getElementById("lightIndicator");
        const lightToggle = document.getElementById("lightToggle");

        if (isLightOn) {
          lightIndicator.classList.add("light-on");
          lightIndicator.classList.add("animate-light-pulse");
          lightToggle.checked = true;
        } else {
          lightIndicator.classList.remove("light-on");
          lightIndicator.classList.remove("animate-light-pulse");
          lightToggle.checked = false;
        }
      }

      // Function to start movement in a specific direction
      function startMovement(direction) {
        if (currentDirection === direction && isMoving) return;

        // Stop any existing movement
        stopMovement();

        currentDirection = direction;
        isMoving = true;

        // Send the initial command
        sendCmd(direction);

        // Set up interval to repeatedly send command while button is held
        intervalId = setInterval(() => {
          if (isMoving) {
            sendCmd(direction);
          }
        }, 100); // Send command every 100ms
      }

      // Function to stop movement
      function stopMovement() {
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }

        if (isMoving) {
          sendCmd("stop");
          isMoving = false;
          currentDirection = null;
        }
      }

      // Function to send command
      function sendCmd(cmd) {
        if (!client.connected) return;
        client.publish(topicControl, cmd);
        console.log(`Sent command: ${cmd}`);
      }

      // --- Button Event Handlers ---
      const buttons = {
        forward: document.getElementById("btn-forward"),
        backward: document.getElementById("btn-backward"),
        left: document.getElementById("btn-left"),
        right: document.getElementById("btn-right"),
        stop: document.getElementById("btn-stop"),
      };

      // Light toggle event handler
      const lightToggle = document.getElementById("lightToggle");
      lightToggle.addEventListener("change", toggleLights);

      // Add event listeners for mouse/touch
      buttons.forward.addEventListener("mousedown", () => {
        buttons.forward.classList.add("btn-active");
        startMovement("forward");
      });

      buttons.backward.addEventListener("mousedown", () => {
        buttons.backward.classList.add("btn-active");
        startMovement("backward");
      });

      buttons.left.addEventListener("mousedown", () => {
        buttons.left.classList.add("btn-active");
        startMovement("left");
      });

      buttons.right.addEventListener("mousedown", () => {
        buttons.right.classList.add("btn-active");
        startMovement("right");
      });

      buttons.stop.addEventListener("mousedown", () => {
        buttons.stop.classList.add("stop-active");
        stopMovement();
      });

      // Add event listeners for mouse up/touch end
      document.addEventListener("mouseup", () => {
        Object.values(buttons).forEach((btn) => {
          btn.classList.remove("btn-active", "stop-active");
        });
        stopMovement();
      });

      // Touch events for mobile
      buttons.forward.addEventListener("touchstart", (e) => {
        e.preventDefault();
        buttons.forward.classList.add("btn-active");
        startMovement("forward");
      });

      buttons.backward.addEventListener("touchstart", (e) => {
        e.preventDefault();
        buttons.backward.classList.add("btn-active");
        startMovement("backward");
      });

      buttons.left.addEventListener("touchstart", (e) => {
        e.preventDefault();
        buttons.left.classList.add("btn-active");
        startMovement("left");
      });

      buttons.right.addEventListener("touchstart", (e) => {
        e.preventDefault();
        buttons.right.classList.add("btn-active");
        startMovement("right");
      });

      buttons.stop.addEventListener("touchstart", (e) => {
        e.preventDefault();
        buttons.stop.classList.add("stop-active");
        stopMovement();
      });

      document.addEventListener("touchend", () => {
        Object.values(buttons).forEach((btn) => {
          btn.classList.remove("btn-active", "stop-active");
        });
        stopMovement();
      });

      // --- KEYBOARD CONTROL LOGIC ---
      // Listen for key presses
      document.addEventListener("keydown", (event) => {
        // Prevent repeated commands if a key is held down
        if (event.repeat) return;

        switch (event.key) {
          case "ArrowUp":
          case "w":
          case "W":
            buttons.forward.classList.add("btn-active");
            startMovement("forward");
            break;
          case "ArrowDown":
          case "s":
          case "S":
            buttons.backward.classList.add("btn-active");
            startMovement("backward");
            break;
          case "ArrowLeft":
          case "a":
          case "A":
            buttons.left.classList.add("btn-active");
            startMovement("left");
            break;
          case "ArrowRight":
          case "d":
          case "D":
            buttons.right.classList.add("btn-active");
            startMovement("right");
            break;
          case " ": // Space bar
          case "x":
          case "X":
            buttons.stop.classList.add("stop-active");
            stopMovement();
            break;
          case "l":
          case "L":
            // Toggle lights with L key
            toggleLights();
            break;
        }
      });

      // Listen for key releases to reset button visuals
      document.addEventListener("keyup", (event) => {
        switch (event.key) {
          case "ArrowUp":
          case "w":
          case "W":
            buttons.forward.classList.remove("btn-active");
            stopMovement();
            break;
          case "ArrowDown":
          case "s":
          case "S":
            buttons.backward.classList.remove("btn-active");
            stopMovement();
            break;
          case "ArrowLeft":
          case "a":
          case "A":
            buttons.left.classList.remove("btn-active");
            stopMovement();
            break;
          case "ArrowRight":
          case "d":
          case "D":
            buttons.right.classList.remove("btn-active");
            stopMovement();
            break;
          case " ": // Space bar
          case "x":
          case "X":
            buttons.stop.classList.remove("stop-active");
            break;
        }
      });

      // Initialize with default speed
      sendSpeed();
    </script>
  </body>
</html>
